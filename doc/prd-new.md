# 资产管理系统 (Cola Finance) 产品需求文档

| 文档版本 | 修改日期 | 修改人 | 备注 |
| :--- | :--- | :--- | :--- |
| v2.0 | 2025-12-05 | AI Assistant | 基于原 PRD 整合 v2 需求，统一口径与架构规范 |

## 1. 产品概述 (Overview)

### 1.1 背景
随着个人投资渠道的多元化，用户的资产分散在多个券商（东方财富、盈透证券）和基金平台（天天基金、雪球）。跨平台查看资产状况需要频繁切换 App，且缺乏统一的统计口径（如币种折算、收益计算方式不一致），导致用户难以快速掌握整体资产全貌并进行有效的再平衡。

### 1.2 产品愿景
打造一个**单用户、本地优先、隐私安全**的资产全景看板。通过自动化采集与统一数据口径，为用户提供上帝视角的资产透视，辅助科学的资产配置与再平衡决策，减少决策摩擦。

### 1.3 核心价值
- **全景视图**：一屏掌控全球资产，消除“资产碎片化”焦虑。
- **统一口径**：自动处理汇率折算与收益计算，提供可信的财务数据。
- **科学配置**：基于维度的透视与再平衡建议，告别凭感觉调仓。

---

## 2. 用户角色与场景 (User & Scenarios)

**目标用户**：拥有跨平台、多币种资产的个人投资者。

| 场景 | 描述 | 核心需求 |
| :--- | :--- | :--- |
| **早间速览** | 用户早上醒来，想快速了解昨夜美股与昨日A股收盘后的总资产变化。 | 首屏加载快（<800ms），数据自动聚合，汇率已更新。 |
| **月度复盘** | 月末统计各大类资产（权益/债券/商品）的占比，评估是否偏离目标。 | 灵活的维度切换，清晰的饼图/透视图，偏离度高亮。 |
| **资金调仓** | 账户有一笔闲置资金，想知道投入到哪个市场或标的能平衡当前配置。 | 再平衡建议，基于目标占比给出具体的买入/卖出金额推荐。 |
| **数据维护** | 发现某只新买的基金未自动归类，或分类错误。 | 简单的手动修正功能，且系统能“记住”用户的修正。 |

---

## 3. 功能需求 (Functional Requirements)

采用 **MoSCoW** 原则进行优先级划分。

### 3.1 Must Have (首期必做)

#### 3.1.1 多平台集成
- **支持平台**：东方财富证券、天天基金、雪球基金、盈透证券 (IBKR)。
- **采集方式**：优先使用官方/非公开 API，Playwright 爬虫作为兜底。
- **核心数据**：持仓明细（代码、名称、数量、成本、现价、币种）、账户余额。
- **容错处理**：单个平台采集失败不影响整体展示，界面需标注“数据部分过期”。

#### 3.1.2 统一资产看板
- **总览页**：展示总资产（目标币种）、当日收益、累计收益、最新更新时间。
- **资产列表**：支持按平台、账户、资产类型筛选。
- **图表组件**：支持饼图（占比）、柱状图（分布）、矩形树图（热力）。

#### 3.1.3 维度与分类管理
- **预设维度**：
    1. **资产属性**：权益类、债券类、现金类、另类投资。
    2. **市场地域**：美股、A股、港股、其他。
- **手动分类**：用户可强制指定某资产属于特定分类（优先级最高）。
- **分类逻辑**：手动分类 > 规则映射（预设） > 自动分类（AI/Fallback）。

#### 3.1.4 币种与汇率
- **多币种支持**：原始资产保留原币种（USD, HKD, CNY 等）。
- **统一折算**：所有资产按配置的目标币种（默认 CNY）进行折算展示。
- **汇率源**：后台定时拉取汇率，支持配置更新频率。

#### 3.1.5 再平衡 (Rebalancing)
- **目标设定**：用户可为“维度”下的每个“分类”设置目标百分比（Target Weight）。
- **容忍区间 (Band)**：支持设置偏离容忍度（如 ±5%）。
- **偏离计算**：实时计算 `当前占比 - 目标占比`。
- **调仓建议**：
    - 若偏离超出 Band，生成建议（“买入 10,000 CNY” 或 “卖出 500 USD”）。
    - 建议需考虑最小交易单位（如 1手 = 100股）。

#### 3.1.6 刷新与缓存
- **后台任务**：默认每小时自动采集一次（可配置）。
- **前端刷新**：默认每 5 分钟轮询一次。
- **ETag 机制**：接口返回 `ETag`（基于快照哈希），前端通过 `If-None-Match` 避免无效重绘。

### 3.2 Should Have (二期规划)
- **AI 智能分类**：对于未识别资产，调用 LLM 进行自动打标（需用户确认）。
- **国际化**：支持中/英界面切换。
- **费用口径**：在收益计算中可选是否包含预估税费/手续费。
- **离线模式**：网络不可用时，完整展示最后一次成功快照的数据。

### 3.3 Could Have (未来扩展)
- **AI Agent 顾问**：基于市场简报与当前持仓，生成自然语言的配置报告。
- **自定义图表**：用户拖拽配置看板布局。

---

## 4. 数据逻辑与算法 (Data Logic)

### 4.1 统一字段模型
所有平台采集的数据必须清洗为以下标准结构 (`AssetHolding`)：

| 字段 | 类型 | 说明 | 计算/来源规则 |
| :--- | :--- | :--- | :--- |
| `platform` | Enum | 来源平台 | 东财/天天/雪球/IBKR |
| `symbol` | String | 资产代码 | 唯一标识，如 `sh600519`, `AAPL` |
| `quantity` | Decimal | 持有数量 | 股票股数或基金份额 |
| `price` | Decimal | 最新单价 | 市价或单位净值 |
| `costPrice` | Decimal | 成本单价 | 优先平台数据，缺失则允许用户录入或标记为0 |
| `currency` | Enum | 资产币种 | USD/CNY/HKD 等 |
| `marketValue` | Decimal | 市值 | `quantity * price` |
| `dayProfit` | Decimal | 当日收益 | 优先平台数据，缺失则 `(price - prevClose) * quantity` |
| `totalProfit` | Decimal | 累计收益 | `(price - costPrice) * quantity` |

### 4.2 汇率折算规则
- **公式**：`DisplayValue = AssetValue * FX_Rate(AssetCurrency -> TargetCurrency)`
- **精度**：
    - 汇率保留 4 位小数。
    - 金额显示保留 2 位小数。
- **三角换汇**：若无直接汇率（如 JPY -> AUD），通过中间货币（USD）计算。

### 4.3 再平衡算法
1. **输入**：当前总资产折算值 ($V_{total}$)，某分类目标占比 ($W_{target}$)，当前占比 ($W_{current}$)，容忍度 ($B$)。
2. **判断**：如果不满足 $|W_{current} - W_{target}| > B$，则无需操作。
3. **计算**：
    - 目标金额 $V_{target} = V_{total} * W_{target}$
    - 需调整金额 $\Delta V = V_{target} - V_{current}$
4. **输出**：
    - $\Delta V > 0$：建议买入 $\Delta V$。
    - $\Delta V < 0$：建议卖出 $|\Delta V|$。

---

## 5. 非功能需求 (Non-functional Requirements)

### 5.1 性能 (Performance)
- **API 响应**：关键查询接口（概览/明细）P95 < 800ms（缓存命中下）。
- **全量刷新**：后台采集任务并发执行，整体更新周期 < 1分钟（依赖上游响应）。

### 5.2 安全与隐私 (Security & Privacy)
- **本地优先**：所有敏感数据（持仓、金额）存储在本地数据库，不上传云端。
- **凭证加密**：平台账号/Token 使用操作系统级密钥库或加密文件存储。
- **日志脱敏**：日志中严禁打印 Session ID、Password、持仓金额等敏感信息。

### 5.3 可靠性 (Reliability)
- **降级策略**：某平台采集失败时，UI 仅置灰该部分数据并显示上次更新时间，不阻断整体使用。
- **重试机制**：采集任务支持指数退避重试（Exponential Backoff）。

---

## 6. 交互与信息架构 (IA & UX)

- **Dashboard (首页)**
    - 核心指标卡（总资产、日收益）。
    - 资产分布图（默认按“资产属性”维度）。
    - 快捷操作：刷新数据、切换维度。
- **Asset List (资产明细)**
    - 表格视图，支持多级分组（平台 -> 账户 -> 资产）。
    - 搜索与筛选栏。
- **Allocation (配置与再平衡)**
    - 左侧：维度树状图与目标占比设置。
    - 右侧：偏离度仪表盘与调仓建议列表。
- **Settings (设置)**
    - 账号绑定与状态管理。
    - 基础设置（目标币种、刷新频率）。
    - 开发者选项（查看日志、手动触发任务）。

---

## 7. 附录：开发里程碑 (Milestones)

| 阶段 | 目标 | 关键交付物 |
| :--- | :--- | :--- |
| **M1: 核心骨架** | 跑通全链路，实现数据采集与展示。 | 数据库Schema，4个平台适配器，概览页，明细页。 |
| **M2: 维度与统计** | 实现多维度透视与汇率折算。 | 维度管理模块，汇率服务，图表组件。 |
| **M3: 策略与完善** | 再平衡功能与系统稳健性。 | 再平衡算法，Band设置，设置页，CI/CD流水线。 |
