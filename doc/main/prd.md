# 资产管理系统 (Cola Finance) 产品需求文档

| 文档版本 | 修改日期 | 修改人 | 备注 |
| :--- | :--- | :--- | :--- |
| v2.4 | 2025-12-19 | AI Assistant | 新增 PWA 支持 (安装到桌面/主屏幕) |
| v2.3 | 2025-12-19 | AI Assistant | 新增用户注册、消息中心、家庭组 (Family Group) 功能 |
| v2.2 | 2025-12-06 | AI Assistant | 新增模拟平台 (Mock)、术语修正 (Adapter) |
| v2.1 | 2025-12-06 | AI Assistant | 新增多用户、每日快照覆盖策略、走势图与时区定义 |
| v2.0 | 2025-12-05 | AI Assistant | 基于原 PRD 整合 v2 需求，统一口径与架构规范 |

## 1. 产品概述 (Overview)

### 1.1 背景
随着个人投资渠道的多元化，用户的资产分散在多个券商（东方财富、盈透证券）和基金平台（天天基金、雪球）。跨平台查看资产状况需要频繁切换 App，且缺乏统一的统计口径（如币种折算、收益计算方式不一致），导致用户难以快速掌握整体资产全貌并进行有效的再平衡。

### 1.2 产品愿景
打造一个**本地优先、隐私安全、支持多用户与家庭协作**的资产全景看板。通过自动化采集与统一数据口径，为用户提供上帝视角的资产透视，辅助科学的资产配置与再平衡决策。

### 1.3 核心价值
- **全景视图**：一屏掌控全球资产，消除“资产碎片化”焦虑。
- **历史回溯**：记录每日资产与收益走势，复盘投资表现。
- **家庭协作**：支持建立“家庭组”，透视全家总资产与收益状况。
- **统一口径**：自动处理汇率折算与收益计算，提供可信的财务数据。
- **科学配置**：基于维度的透视与再平衡建议，告别凭感觉调仓。

---

## 2. 用户角色与场景 (User & Scenarios)

**目标用户**：拥有跨平台、多币种资产的个人投资者（支持家庭多成员使用）。

| 场景 | 描述 | 核心需求 |
| :--- | :--- | :--- |
| **开发测试** | 开发者或新用户希望快速体验系统功能，但不想配置真实账户。 | **模拟数据源 (Mock)**，一键生成演示数据。 |
| **家庭资产透视** | 夫妻双方各自管理账户，但希望看到整个家庭的财务状况。 | **家庭组 (Family Group)**，组队后查看汇总数据。 |
| **消息通知** | 用户收到组队邀请或系统状态更新。 | **消息中心**，处理邀请和查看通知。 |
| **早间速览** | 用户早上醒来，想快速了解昨夜美股与昨日A股收盘后的总资产变化。 | 首屏加载快（<800ms），数据自动聚合，汇率已更新。 |
| **走势复盘** | 周末复盘，查看近一年总资产增长曲线，以及收益率是否跑赢基准。 | 清晰的**资产走势图**与**累计收益率曲线**。 |

---

## 3. 功能需求 (Functional Requirements)

采用 **MoSCoW** 原则进行优先级划分。

### 3.1 Must Have (首期必做)

#### 3.1.1 用户与授权 (Identity)
- **注册与登录**：
  - 支持用户注册（用户名/密码）。
  - 登录后发放 Token，作为后续请求的凭证。
- **凭证管理**：
  - 用户登录后，在个人设置中添加平台账户。
  - **凭证隔离**：每个用户需独立输入各平台的 API Key 或登录凭证，系统加密存储。

#### 3.1.2 多平台数据适配 (Adapters)
- **支持平台**：东方财富证券、天天基金、雪球基金、盈透证券 (IBKR)、嘉信理财 (Charles Schwab)。
- **扩展性设计**：架构需支持低成本接入新平台（如富途、老虎），仅需实现标准接口即可插件化扩展。
- **数据获取方式**：
  1.  **官方/非公开 API**：优先使用，稳定且速度快。
  2.  **模拟数据源 (Mock)**：用于开发、测试或演示，生成随机/固定数据。
  3.  **网页爬取 (Crawler)**：仅在无 API 可用时作为兜底方案 (Playwright)。
- **核心数据**：持仓明细（代码、名称、数量、成本、现价、币种）、账户余额。
- **容错处理**：单个平台获取失败不影响整体展示，界面需标注“数据部分过期”。

#### 3.1.3 统一资产看板与走势图
- **总览页**：
  - 核心卡片：总资产、当日收益、累计收益、最新更新时间。
  - **走势图表**：
    1.  **资产走势图**：每日总资产（折合目标币种）的变化曲线。
    2.  **收益走势图**：每日绝对收益金额的柱状/曲线图。
    3.  **累计收益率图**：基于每日收益率复利计算的累计走势 (`(1+r1)*(1+r2)... - 1`)。
  - **时间范围筛选**：
    - 支持以下固定范围：**本月、近三月、近6月、近一年、近两年、近三年、近五年、近十年、全部**。
    - **偏好记忆**：前端需自动保存用户上次选择的时间范围，下次打开时默认应用该范围。
- **资产列表**：支持按平台、账户、资产类型筛选。

#### 3.1.4 维度与分类管理
- **预设维度**：
  1. **资产属性**：权益类、债券类、现金类、另类投资。
  2. **市场地域**：美股、A股、港股、其他。
- **手动分类**：用户可强制指定某资产属于特定分类（优先级最高）。

#### 3.1.5 币种与汇率
- **多币种支持**：原始资产保留原币种（USD, HKD, CNY 等）。
- **统一折算**：所有资产按配置的目标币种（默认 CNY）进行折算展示。
- **汇率源**：后台定时拉取汇率，支持配置更新频率。

#### 3.1.6 再平衡 (Rebalancing)
- **目标设定**：用户可为“维度”下的每个“分类”设置目标百分比（Target Weight）。
- **容忍区间 (Band)**：支持设置偏离容忍度（如 ±5%）。
- **调仓建议**：若偏离超出 Band，生成具体的买入/卖出金额推荐。

#### 3.1.7 刷新与快照策略
- **每日快照 (Daily Snapshot)**：
  - 系统以 **“天”** 为单位保存历史数据。
  - **覆盖策略**：若同一天内多次刷新/采集数据，**覆盖**当天的旧快照，仅保留该日最新的一份数据。

#### 3.1.8 模拟平台 (Mock Platform)
- **功能**：提供一个名为 "Mock Broker" 的虚拟券商选项。
- **能力**：
  - 无需真实账号密码即可连接。
  - 自动生成若干只股票/基金的持仓数据。
  - 支持模拟价格波动（每次刷新价格随机浮动），方便测试走势图和再平衡逻辑。

#### 3.1.9 消息中心 (Message Center)
- **功能**：提供应用内通知机制。
- **消息类型**：
  - **邀请通知**：收到加入家庭组的邀请。
  - **系统通知**：数据采集失败、版本更新等提醒。
- **操作**：
  - 用户可在消息中心查看未读消息。
  - 对邀请类消息进行“接受”或“拒绝”操作。

#### 3.1.10 家庭组 (Family Group)
- **概念**：支持多用户组成一个“投资组”或“家庭组”，实现资产视角的合并。
- **流程**：
  1.  **创建**：用户创建一个组（如“我的家庭”）。
  2.  **邀请**：组长通过用户名邀请其他已注册用户。
  3.  **加入**：被邀请人在“消息中心”收到通知，确认后加入。
- **聚合看板**：
  - **数据汇总**：统计组内所有成员的**日收益、月收益、年收益、累计收益**的总和。
  - **合并走势**：展示家庭维度的**日/月/年资产走势图**。
  - **隐私控制**：仅展示汇总数据或持仓详情（可配置，默认全公开）。

#### 3.1.11 PWA 支持 (Progressive Web App)
- **安装能力**：支持添加到桌面（PC）或主屏幕（Mobile），提供类原生 App 体验。
- **离线访问**：支持离线加载应用壳（App Shell），网络恢复后自动重连。
- **启动配置**：配置 manifest.json，支持独立窗口启动，自定义图标与启动屏。

#### 3.1.12 管理后台 (Admin Portal)
- 详见独立文档：[`doc/admin/prd.md`](../admin/prd.md) 与 [`doc/admin/design.md`](../admin/design.md)
- **核心功能**：独立的管理员账号体系、用户管理（封禁/解封）、系统配置（爬取间隔/频率限制）、监控看板。
- **技术定位**：独立部署的 SPA 应用 (`apps/admin`)，与 C 端用户物理隔离。

### 3.2 Should Have (二期规划)
- **AI 智能分类**：对于未识别资产，调用 LLM 进行自动打标。
- **国际化**：支持中/英界面切换。
- **离线模式**：网络不可用时，完整展示最后一次成功快照的数据。

---

## 4. 数据逻辑与算法 (Data Logic)

### 4.1 业务日期与时区 (Business Date)
鉴于全球资产交易时间不同（A股 15:00 收盘，美股次日凌晨 04:00/05:00 收盘），系统需统一定义“日期”。

- **规则**：以 **用户设置的本地时区**（默认 UTC+8）为基准确定“业务日期”。
- **判定**：
  - 当用户在 `2025-12-06 10:00 (UTC+8)` 发起刷新，系统记录该快照的业务日期为 `2025-12-06`。
  - 即使包含的美股数据实际上是 `12-05` 的收盘价，在用户视角下，这就是“今天 (`12-06`)”的资产状态。
- **存储**：快照记录字段 `date: "2025-12-06"` 和 `timestamp: 1733450400000`。

### 4.2 收益率计算
- **当日收益率 (Daily Return)**: $R_{daily} = \frac{Profit_{daily}}{Asset_{prev\_day}}$
  - 若无前一日数据，则 $R_{daily} = 0$。
- **累计收益率 (Cumulative Return)**:
  - 采用 **时间加权收益率 (TWR)** 的简化近似或**复利累加**：
  - $R_{total} = (1 + R_1) \times (1 + R_2) \times ... \times (1 + R_n) - 1$

### 4.3 家庭组数据聚合
- **总资产**：$\sum (Member_i.TotalAsset)$
- **总收益**：$\sum (Member_i.Profit)$
- **聚合收益率**：需基于合并后的每日总资产流计算，而非简单的收益率加权平均。

### 4.4 统一字段模型 (`AssetHolding`)
所有平台采集的数据必须清洗为以下标准结构：

| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `symbol` | String | 资产代码 |
| `quantity` | Decimal | 持有数量 |
| `price` | Decimal | 最新单价 |
| `costPrice` | Decimal | 成本单价 |
| `currency` | Enum | 资产币种 |
| `marketValue` | Decimal | 市值 `quantity * price` |
| `dayProfit` | Decimal | 当日收益 |
| `totalProfit` | Decimal | 累计收益 |

---

## 5. 非功能需求 (Non-functional Requirements)

### 5.1 性能
- **接口响应**：历史走势接口（365个点）需在 500ms 内返回。
- **并发**：支持家庭用户（<10人）同时使用。

### 5.2 安全与隐私
- **数据隔离**：不同用户的 API 请求必须携带 Token，严禁跨用户数据访问。
- **本地优先**：敏感凭证加密存储于本地数据库。

---

## 6. 附录：开发里程碑 (Milestones)

| 阶段 | 目标 | 关键交付物 |
| :--- | :--- | :--- |
| **M1: 核心骨架** | 跑通多用户、采集与每日快照。 | 用户系统，数据库Schema，Mock适配器，每日覆盖逻辑，基础看板。 |
| **M2: 家庭与协作** | 实现家庭组与消息通知。 | 注册/登录，消息中心，家庭组管理，聚合看板。 |
| **M3: 趋势与分析** | 实现走势图与累计收益率。 | 历史数据 API，ECharts 走势图，收益率算法。 |
